name: Deploy Bot

on:
    workflow_dispatch:
    push:
        branches:
            - 'main'

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v3

            - name: Login to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Set owner name to lowercase
              run: echo "OWNER_LC=${OWNER,,}" >> $GITHUB_ENV
              env:
                  OWNER: '${{ github.repository_owner }}'

            - name: Build and push image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: ./Dockerfile
                  push: true
                  tags: |
                      ghcr.io/${{ env.OWNER_LC }}/aredl-manager-v3:latest
                      ghcr.io/${{ env.OWNER_LC }}/aredl-manager-v3:${{ github.sha }}
                  cache-from: type=registry,ref=ghcr.io/${{ env.OWNER_LC }}/aredl-manager-v3:buildcache
                  cache-to: type=registry,ref=ghcr.io/${{ env.OWNER_LC }}/aredl-manager-v3:buildcache,mode=max

            - name: Build config template
              run: |
                  cat > config.template.json <<'EOF'
                  {
                    "token": "{{ secret `aredl_manager_v3_bot_token` }}",
                    "apiToken": "{{ secret `aredl_manager_v3_api_token` }}",
                    "websocketURL": "${{ secrets.WEBSOCKET_URL }}",
                    "baseURL": "${{ secrets.BASE_URL }}",
                    "enableSeparateStaffServer": ${{ secrets.ENABLE_SEPARATE_STAFF_SERVER }},
                    "enableWelcomeMessage": ${{ secrets.ENABLE_WELCOME_MESSAGE }},
                    "clientId": "${{ secrets.CLIENT_ID }}",
                    "guildId": "${{ secrets.GUILD_ID }}",
                    "staffGuildId": "${{ secrets.STAFF_GUILD_ID }}",
                    "infoMessageUpdateSchedule": "${{ secrets.INFO_MESSAGE_UPDATE_SCHEDULE }}",
                    "classicArchiveRecordsID": "${{ secrets.CLASSIC_ARCHIVE_RECORDS_ID }}",
                    "platArchiveRecordsID": "${{ secrets.PLAT_ARCHIVE_RECORDS_ID }}",
                    "classicRecordsID": "${{ secrets.CLASSIC_RECORDS_ID }}",
                    "platRecordsID": "${{ secrets.PLAT_RECORDS_ID }}",
                    "guildMemberAddID": "${{ secrets.GUILD_MEMBER_ADD_ID }}",
                    "completedShiftsID": "${{ secrets.COMPLETED_SHIFTS_ID }}",
                    "shiftsStartedID": "${{ secrets.SHIFTS_STARTED_ID }}",
                    "missedShiftsID": "${{ secrets.MISSED_SHIFTS_ID }}",
                    "enableShiftReminders": ${{ secrets.ENABLE_SHIFT_REMINDERS }},
                    "sendShiftRemindersSchedule": "${{ secrets.SEND_SHIFT_REMINDERS_SCHEDULE }}",
                    "shiftReminderExpireThreshold": ${{ secrets.SHIFT_REMINDER_EXPIRE_THRESHOLD }},
                    "pointsRoleIDs": ${{ secrets.POINTS_ROLE_IDS }},
                    "packRoleIDs": ${{ secrets.PACK_ROLE_IDS }},
                    "topLevelRoleIDs": ${{ secrets.TOP_LEVEL_ROLE_IDS }},
                    "extremeGrinderRoleID": "${{ secrets.EXTREME_GRINDER_ROLE_ID }}",
                    "opinionPermsRoleID": "${{ secrets.OPINION_PERMS_ROLE_ID }}",
                    "creatorRoleID": "${{ secrets.CREATOR_ROLE_ID }}",
                    "verifierRoleID": "${{ secrets.VERIFIER_ROLE_ID }}",
                    "timeoutLogsChannelID": "${{ secrets.TIMEOUT_LOGS_CHANNEL_ID }}"
                  }
                  EOF

            - name: Copy compose file
              uses: appleboy/scp-action@v0.1.4
              with:
                  host: ${{ secrets.DEPLOY_HOST }}
                  username: ${{ secrets.DEPLOY_USER }}
                  key: ${{ secrets.DEPLOY_KEY }}
                  source: 'docker-stack.yml,config.template.json'
                  target: ${{ secrets.DEPLOY_PATH }}

            - name: Deploy container
              uses: appleboy/ssh-action@v1.0.0
              env:
                  GHCR_USERNAME: ${{ github.actor }}
                  GHCR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
                  IMAGE_REPO: ghcr.io/${{ env.OWNER_LC }}/aredl-manager-v3
                  BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
                  API_TOKEN: ${{ secrets.API_TOKEN }}
              with:
                  host: ${{ secrets.DEPLOY_HOST }}
                  username: ${{ secrets.DEPLOY_USER }}
                  key: ${{ secrets.DEPLOY_KEY }}
                  envs: GHCR_USERNAME,GHCR_TOKEN,DEPLOY_PATH,IMAGE_REPO,BOT_TOKEN,API_TOKEN
                  script: |
                      cd $DEPLOY_PATH
                      docker stack rm aredl_manager_v3_stack 2>/dev/null || true
                      echo "Waiting for bot service to stopâ€¦"
                      until ! docker service inspect aredl_manager_v3_stack_bot >/dev/null 2>&1; do
                        sleep 1
                      done
                      docker secret rm aredl_manager_v3_bot_token aredl_manager_v3_api_token 2>/dev/null || true
                      echo -n "$BOT_TOKEN" | docker secret create aredl_manager_v3_bot_token -
                      echo -n "$API_TOKEN" | docker secret create aredl_manager_v3_api_token -
                      docker config rm aredl_manager_v3_config 2>/dev/null || true
                      docker config create --template-driver golang aredl_manager_v3_config config.template.json
                      docker login ghcr.io -u $GHCR_USERNAME -p $GHCR_TOKEN
                      IMAGE_REPO=$IMAGE_REPO docker stack deploy --with-registry-auth -c docker-stack.yml aredl_manager_v3_stack
                      docker image prune -f
